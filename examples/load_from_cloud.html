<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>


	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>

	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.868.0.min.js"></script>
	<!-- INCLUDE SETTINGS HERE -->
       <script src="https://apis.google.com/js/client.js"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

       <!-- <script src="../bundle.js" bucket="potree-files" file="lion_takanawa/cloud.js"></script> -->

       <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>

        <div id="login-form">
          <label for="name">Name</label>
          <input type="text" size=20
                 value="lion"
                 name="name" id="name" required>
          <br/>
          <label for="path">Path</label>
          <input type="text" size=40
                 value="lion_takanawa_v2/metadata.json"
                 name="path" id="path" required>
          <br/><br/>
          <b>AWS S3</b>
          <br/>
          <label for="region">Region</label>
          <input type="text" size=20
                 placeholder="REGION"
                 name="region" id="region" required>
          <br/>
          <label for="bucket">Bucket</label>
          <input type="text" size=40
                 placeholder="BUCKET"
                 name="bucket" id="bucket" required>
          <br/>
          <label for="folder">Folder</label>
          <input type="text" size=40
                 placeholder="FOLDER"
                 name="folder" id="folder" required>
          <br/>
          <label for="uname">AWS Access Key ID</label>
          <input type="text" size=20
                 placeholder="AWS_ACCESS_KEY_ID"
                 name="uname" id="key" required>
          <br/>
          <label for="psw">AWS Secret Access Key</label>
          <input type="password" size=40
                 placeholder="AWS_SECRET_ACCESS_KEY" name="psw" id="secret" required>
          <br/>
          <button type="submit" id="aws-start-button">Start</button>
        </div>

        <br/><br/>
          <b>Microsoft Azure</b>
          <br/>
          <label for="account_name">Account Name</label>
          <input type="text" size=20
                 placeholder="ACCOUNT_NAME"
                 name="azure_account_name" id="azure_account_name" required>
          <br/>
          <label for="container">Container</label>
          <input type="text" size=20
                 placeholder="CONTAINER"
                 name="container" id="container" required>
          <br/>
          <label for="azure_secret_key">Azure Secret Key</label>
          <input type="password" size=40
                 placeholder="AZURE_SECRET_KEY"
                 name="azure_secret_key" id="azure_secret" required>
          <br/>
          <button type="submit" id="azure-start-button">Start</button>
        </div>

        <br/><br/>
          <b>Google Cloud Platform</b>
          <br/>
          <label for="client_email">Client Email</label>
          <input type="text" size=20
                 placeholder="CLIENT_EMAIL"
                 name="gcp_client_email" id="gcp_client_email" required>
          <br/>
          <label for="gcp_bucket">Bucket</label>
          <input type="text" size=20
                 placeholder="BUCKET"
                 name="gcp_bucket" id="gcp_bucket" required>
          <br/>
          <label for="gcp_private_key">GCP Private Key</label>
          <input type="password" size=40
                 placeholder="GCP_PRIVATE_KEY"
                 name="gcp_private_key" id="gcp_private_key" required>
          <br/>
          <label for="choose_key_file">Key File</label>
          <input type="file" size=40
                 placeholder="KEY_FILE"
                 name="key_file" id="key_file" required>
          <br/>


       <!--    <input type="file" name="inputfile"
          id="inputfile" required> -->



          <button type="submit" id="gcp-start-button">Start</button>
        </div>

        <div id="potree-container" class="potree_container" style="display: none; position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('../build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"> </div>
	</div>


	<script type="module">


  // AWS
  async function runAWSExample() {
        const NAME = document.getElementById("name").value;
        const PATH = document.getElementById("path").value;
        const REGION = document.getElementById("region").value;
        const BUCKET = document.getElementById("bucket").value;
        const FOLDER = document.getElementById("folder").value;
        const AWS_ACCESS_KEY_ID = document.getElementById("key").value;
        const AWS_SECRET_ACCESS_KEY = document.getElementById("secret").value;
        document.getElementById("login-form").style.display = "none";
        document.getElementById("potree-container").style.display = "initial";
    		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    		viewer.setEDLEnabled(true);
    		viewer.setFOV(60);
    		viewer.setPointBudget(1_000_000);
    		viewer.loadSettingsFromURL();

    		viewer.setDescription("");

    		viewer.loadGUI(() => {
    			viewer.setLanguage('en');
    			$("#menu_appearance").next().show();
    			//viewer.toggleSidebar();
    		});

        const s3 = new AWS.S3({
          region: REGION,
          accessKeyId: AWS_ACCESS_KEY_ID,
          secretAccessKey: AWS_SECRET_ACCESS_KEY
        });

        const signUrl =
          // For AWS JavaScript API v2, this doesn't need to be async.
          // But v3 and other cloud APIs will need async / await.
           async (url, headers) => s3.getSignedUrl('getObject',
                                            {
                                              Bucket: BUCKET,
                                              Key: url,
                                              ...(headers || {})
                                            });

    	    const e = await Potree.loadPointCloud(FOLDER + "/" + PATH, NAME, null, signUrl);
    	    viewer.scene.addPointCloud(e.pointcloud);
    	    const material = e.pointcloud.material;
    	    material.size = 1;
    	    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

    	    viewer.fitToScreen();
       }

    const awsButton = document.getElementById("aws-start-button");
    awsButton.addEventListener('click', runAWSExample);



// these functions are in attempt to use subtlecrypto
function str2ab(str) {
  var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
  var bufView = new Uint16Array(buf);
  for (var i=0, strLen=str.length; i < strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}

async function generateKey(azureKey) {

  const cryptoKey = window.crypto.subtle.importKey(
    "raw", //can be "jwk" or "raw"
    str2ab(btoa(azureKey)),
    {   //this is the algorithm options
        name: "HMAC",
        hash: {name: "SHA-256"}, //can be "SHA-1", "SHA-256", "SHA-384", or "SHA-512"
        //length: 256, //optional, if you want your key length to differ from the hash function's block length
    },
    false, //whether the key is extractable (i.e. can be used in exportKey)
    ["sign", "verify"] //can be any combination of "sign" and "verify"
  );
  return cryptoKey;
}


async function getKey(azureKey) {
  const key = await generateKey(azureKey);
  return key;
}

async function getSig(algorithm, key, data) {
  const signature = crypto.subtle.sign(algorithm, key, data);
  return signature;
}



// Microsoft Azure
async function getAzureSignedUrl(url, accountName, azureKey) {
  const start = new Date().getTime();
  const end = new Date(new Date().getTime() + (1000 * 43200)); // accessible for 12 hours
  const signedpermissions = 'rl';
  const signedservice = 'b';
  const signedresourcetype = 'sco';
  const signedexpiry = end.toISOString().substring(0, end.toISOString().lastIndexOf('.')) + 'Z';
  const signedProtocol = 'https';
  const signedversion = '2020-02-10';

  const stringToSign =
      accountName + '\n' +
      signedpermissions + '\n' +
      signedservice + '\n' +
      signedresourcetype + '\n' +
       '\n' +
      signedexpiry + '\n' +
       '\n' +
      signedProtocol + '\n' +
      signedversion + '\n';


  // this is an attempt to use subtoCrypto lib
  const secretKey = await getKey(azureKey);
  const algorithm = "HMAC";
  const key = secretKey;
  const data = new ArrayBuffer(btoa(stringToSign));
  const signature = await getSig(algorithm, key, data);
  const base64String = btoa(String.fromCharCode(...new Uint8Array(signature)));

  // sha 256 encoding
  const signedString = CryptoJS.HmacSHA256(stringToSign, CryptoJS.enc.Base64.parse(azureKey));
  const sig = CryptoJS.enc.Base64.stringify(signedString);
  const sasToken =`sv=${signedversion}&ss=${signedservice}&srt=${signedresourcetype}&sp=${signedpermissions}&se=${encodeURIComponent(signedexpiry)}&spr=${signedProtocol}&sig=${encodeURIComponent(sig)}`;
  const urlToModifyStart = `${signedProtocol}://${accountName}.blob.core.windows.net/`;
  const urlToModifyEnd = "?".concat(sasToken);
  const pathToAdd = url;
  const azureSas = urlToModifyStart.concat(pathToAdd).concat(urlToModifyEnd);

  return azureSas;
}



async function runAzureExample() {
      const NAME = document.getElementById("name").value;
      const PATH = document.getElementById("path").value
      const ACCOUNT_NAME = document.getElementById("azure_account_name").value;
      const CONTAINER = document.getElementById("container").value;
      const AZURE_SECRET_KEY = document.getElementById("azure_secret").value;
      document.getElementById("login-form").style.display = "none";
      document.getElementById("potree-container").style.display = "initial";
  		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

  		viewer.setEDLEnabled(true);
  		viewer.setFOV(60);
  		viewer.setPointBudget(1_000_000);
  		viewer.loadSettingsFromURL();

  		viewer.setDescription("");

  		viewer.loadGUI(() => {
  			viewer.setLanguage('en');
  			$("#menu_appearance").next().show();
  			//viewer.toggleSidebar();
  		});

      const signUrlAzure =
      async (url, headers) => getAzureSignedUrl(url, ACCOUNT_NAME, AZURE_SECRET_KEY);

      const e = await Potree.loadPointCloud(CONTAINER + "/" + PATH, NAME, null, signUrlAzure);
	    viewer.scene.addPointCloud(e.pointcloud);
	    const material = e.pointcloud.material;
	    material.size = 1;
	    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

	    viewer.fitToScreen();
  }

const azureButton = document.getElementById("azure-start-button");
azureButton.addEventListener('click', runAzureExample)


async function runGCPExample() {
  const BUCKET = document.getElementById("gcp_bucket").value;
  const NAME = document.getElementById("name").value;
  const PATH = document.getElementById("path").value;
  const CLIENT_EMAIL = document.getElementById("gcp_client_email").value;
  const PRIVATE_KEY = document.getElementById("gcp_private_key").value;
  const KEY_FILE = document.getElementById("key_file").files[0];
  document.getElementById("login-form").style.display = "none";
  document.getElementById("potree-container").style.display = "initial";
	window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

	viewer.setEDLEnabled(true);
	viewer.setFOV(60);
	viewer.setPointBudget(1_000_000);
	viewer.loadSettingsFromURL();

	viewer.setDescription("");

	viewer.loadGUI(() => {
		viewer.setLanguage('en');
		$("#menu_appearance").next().show();
		//viewer.toggleSidebar();
	});

  var fr = new FileReader();
  fr.onload = async function() {
    const result = fr.result;
    const signUrlGCP =
    async (url, headers) => getGCPSignedUrl(url, headers, result, BUCKET);

    const e = await Potree.loadPointCloud(BUCKET + "/" + PATH, NAME, null, signUrlGCP);
    viewer.scene.addPointCloud(e.pointcloud);
    const material = e.pointcloud.material;
    material.size = 1;
    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

    viewer.fitToScreen();
  }

  fr.readAsText(KEY_FILE);

}

const gcpButton = document.getElementById("gcp-start-button");
gcpButton.addEventListener('click', runGCPExample)




function sha256Encode(arrBuff) {
  return crypto.subtle.digest("SHA-256", arrBuff);
}

function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

// sha-256 hash and hex encode the canonical request
async function encodeCanonical(request) {
  var enc = new TextEncoder(); // always utf-8
  const encodedBufferArray = enc.encode(request);
  const encodedCanonicalArrBuff = await sha256Encode(encodedBufferArray);
  const encodedCanonicalHex = buf2hex(encodedCanonicalArrBuff);

  return encodedCanonicalHex;
}


async function getGCPSignedUrl(url, headers, privateKeyFile, bucket) {

  // extract the private key from the given file.
  const keyHeader = '"private_key": ';
  const keyFooter = '\\n",';
  const keyStart = privateKeyFile.indexOf(keyHeader) + keyHeader.length;
  const keyEnd = privateKeyFile.indexOf(keyFooter);
  const privateKey = privateKeyFile.substring(keyStart, keyEnd).replaceAll("\\n", "\n");

  // extract the client email from the given file.
  const emailHeader = '"client_email": "';
  const emailFooter = '"client_id"';
  const emailEndingToClip = '",';
  const emailStart = privateKeyFile.indexOf(emailHeader) + emailHeader.length;
  const emailEnd = privateKeyFile.indexOf(emailFooter);
  const clientEmailNotClipped = privateKeyFile.substring(emailStart, emailEnd);
  const emailClippedEnd = clientEmailNotClipped.indexOf(emailEndingToClip);
  const clientEmail = clientEmailNotClipped.trim().substring(0, emailClippedEnd).replace("@", "%40");

  // path to file without bucket name
  const pathAfterBucket = url.substring(bucket.length, url.length);

  // consts used in query
  const algorithm = "GOOG4-RSA-SHA256";

  const date = new Date();
  const dateISO = date.toISOString();

  const dateWithSeconds = dateISO.substring(0, dateISO.lastIndexOf('.')) + 'Z';
  const dateWithSecondsFormatted = dateWithSeconds.replaceAll("-", "").replaceAll(":", "").replaceAll(".", "");
  const dateDay = dateISO.substring(0, dateISO.indexOf("T")).replaceAll("-", "").replaceAll(":", "").replaceAll(".", "");
  const expiration = 43200; // accessible for 12 hours

  const canonicalQueryString =
  'X-Goog-Algorithm=' + algorithm +
  '&X-Goog-Credential=' + clientEmail +
  '%2F' + dateDay + '%2Fauto%2Fstorage%2Fgoog4_request' +
  '&X-Goog-Date=' + dateWithSecondsFormatted +
  '&X-Goog-Expires=' + expiration.toString() +
  '&X-Goog-SignedHeaders=host' +
  (!headers? "" : '%3Brange');

  const canonicalRequest =
  'GET\n' +
  pathAfterBucket + '\n' +
  canonicalQueryString + '\n' +
  'host:potree-files.storage.googleapis.com\n' +
  (!headers? '\n' : 'range:' + headers.Range + '\n\n') +
  (!headers? 'host' : 'host;range') + '\n' +
  'UNSIGNED-PAYLOAD';

  const encodedCanonical = await encodeCanonical(canonicalRequest);

  const stringToSign = algorithm + '\n' + dateWithSecondsFormatted + '\n' + dateDay + '/auto/storage/goog4_request\n'
  + encodedCanonical;

  // RSA signature generation
  var sig = new KJUR.crypto.Signature({"alg": "SHA256withRSA"});
  sig.init(privateKey);
  sig.updateString(stringToSign);
  var signature = sig.sign();

  const signedUrl = 'https://' + bucket + '.storage.googleapis.com' + pathAfterBucket + "?" + canonicalQueryString + "&x-goog-signature=" + signature;

  return signedUrl;

}



</script>
  </body>
</html>
