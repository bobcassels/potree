<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	
	
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.853.0.min.js"></script>
	<!-- INCLUDE SETTINGS HERE -->

        <div id="login-form">
          <label for="name">Name</label>
          <input type="text" size=20
                 value="lion"
                 name="name" id="name" required>
          <br/>
          <label for="path">Path</label>
          <input type="text" size=40
                 value="lion_takanawa/cloud.js"
                 name="path" id="path" required>
          <br/><br/>
          <b>AWS S3</b>
          <br/>
          <label for="region">Region</label>
          <input type="text" size=20
                 placeholder="REGION"
                 name="region" id="region" required>
          <br/>
          <label for="bucket">Bucket</label>
          <input type="text" size=40
                 placeholder="BUCKET"
                 name="bucket" id="bucket" required>
          <br/>
          <label for="folder">Folder</label>
          <input type="text" size=40
                 placeholder="FOLDER"
                 name="folder" id="folder" required>
          <br/>
          <label for="uname">AWS Access Key ID</label>
          <input type="text" size=20
                 placeholder="AWS_ACCESS_KEY_ID"
                 name="uname" id="key" required>
          <br/>
          <label for="psw">AWS Secret Access Key</label>
          <input type="password" size=40
                 placeholder="AWS_SECRET_ACCESS_KEY" name="psw" id="secret" required>
          <br/>
          <button type="submit" id="start-button">Start</button>
        </div>

        <div id="potree-container" class="potree_container" style="display: none; position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('../build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"> </div>
	</div>
	
	<script type="module">

	import * as THREE from "../libs/three.js/build/three.module.js";
          async function runExample() {
                const NAME = document.getElementById("name").value;
                const PATH = document.getElementById("path").value;
                const REGION = document.getElementById("region").value;
                const BUCKET = document.getElementById("bucket").value;
                const FOLDER = document.getElementById("folder").value;
                const AWS_ACCESS_KEY_ID = document.getElementById("key").value;
                const AWS_SECRET_ACCESS_KEY = document.getElementById("secret").value;
                document.getElementById("login-form").style.display = "none";
                document.getElementById("potree-container").style.display = "initial";
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
		
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1_000_000);
		viewer.loadSettingsFromURL();
		
		viewer.setDescription("");
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			//viewer.toggleSidebar();
		});

          const s3 = new AWS.S3({
            region: REGION,
            accessKeyId: AWS_ACCESS_KEY_ID,
            secretAccessKey: AWS_SECRET_ACCESS_KEY
          });

          const urlConstructor =
                // Note that for the V3 "modular" AWS API, this will need to be async
                // But that requires significant changes to the loaders. (The loader for
                // the 2.0 OctreeLoader is already async.)
            (url, headers) => s3.getSignedUrl('getObject',
                                              {
                                                Bucket: BUCKET,
                                                Key: FOLDER + "/" + url,
                                                ...(headers || {})
                                              });

	    const e = await Potree.loadPointCloud(PATH, NAME, null, urlConstructor);
	    viewer.scene.addPointCloud(e.pointcloud);
	    const material = e.pointcloud.material;
	    material.size = 1;
	    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

	    viewer.fitToScreen();
          }

          const button = document.getElementById("start-button");
          button.addEventListener('click', runExample)

	</script>

  </body>
</html>
